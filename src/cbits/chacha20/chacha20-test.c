/* chacha20-test.c - chacha/20 test vector harness, based on
     http://tools.ietf.org/html/draft-agl-tls-chacha20poly1305-01#section-7

   Written in 2014 by Austin Seipp <aseipp@pobox.com>

   To the extent possible under law, the author(s) have dedicated all
   copyright and related and neighboring rights to this software to
   the public domain worldwide. This software is distributed without
   any warranty.

   You should have received a copy of the CC0 Public Domain Dedication
   along with this software. If not, see
   <http://creativecommons.org/publicdomain/zero/1.0/>.
*/
#include <stdio.h>
#include <assert.h>

#include "chacha20-portable.c"

unsigned char test1[] =
  { 0x76, 0xb8, 0xe0, 0xad, 0xa0, 0xf1, 0x3d, 0x90, 0x40, 0x5d,
    0x6a, 0xe5, 0x53, 0x86, 0xbd, 0x28, 0xbd, 0xd2, 0x19, 0xb8,
    0xa0, 0x8d, 0xed, 0x1a, 0xa8, 0x36, 0xef, 0xcc, 0x8b, 0x77,
    0x0d, 0xc7, 0xda, 0x41, 0x59, 0x7c, 0x51, 0x57, 0x48, 0x8d,
    0x77, 0x24, 0xe0, 0x3f, 0xb8, 0xd8, 0x4a, 0x37, 0x6a, 0x43,
    0xb8, 0xf4, 0x15, 0x18, 0xa1, 0x1c, 0xc3, 0x87, 0xb6, 0x69 };

unsigned char test2[] =
  { 0x45, 0x40, 0xf0, 0x5a, 0x9f, 0x1f, 0xb2, 0x96, 0xd7, 0x73,
    0x6e, 0x7b, 0x20, 0x8e, 0x3c, 0x96, 0xeb, 0x4f, 0xe1, 0x83,
    0x46, 0x88, 0xd2, 0x60, 0x4f, 0x45, 0x09, 0x52, 0xed, 0x43,
    0x2d, 0x41, 0xbb, 0xe2, 0xa0, 0xb6, 0xea, 0x75, 0x66, 0xd2,
    0xa5, 0xd1, 0xe7, 0xe2, 0x0d, 0x42, 0xaf, 0x2c, 0x53, 0xd7,
    0x92, 0xb1, 0xc4, 0x3f, 0xea, 0x81, 0x7e, 0x9a, 0xd2, 0x75 };

unsigned char test3[] =
  { 0xde, 0x9c, 0xba, 0x7b, 0xf3, 0xd6, 0x9e, 0xf5, 0xe7, 0x86,
    0xdc, 0x63, 0x97, 0x3f, 0x65, 0x3a, 0x0b, 0x49, 0xe0, 0x15,
    0xad, 0xbf, 0xf7, 0x13, 0x4f, 0xcb, 0x7d, 0xf1, 0x37, 0x82,
    0x10, 0x31, 0xe8, 0x5a, 0x05, 0x02, 0x78, 0xa7, 0x08, 0x45,
    0x27, 0x21, 0x4f, 0x73, 0xef, 0xc7, 0xfa, 0x5b, 0x52, 0x77,
    0x06, 0x2e, 0xb7, 0xa0, 0x43, 0x3e, 0x44, 0x5f, 0x41, 0xe3 };

unsigned char test4[] =
  { 0xef, 0x3f, 0xdf, 0xd6, 0xc6, 0x15, 0x78, 0xfb, 0xf5, 0xcf,
    0x35, 0xbd, 0x3d, 0xd3, 0x3b, 0x80, 0x09, 0x63, 0x16, 0x34,
    0xd2, 0x1e, 0x42, 0xac, 0x33, 0x96, 0x0b, 0xd1, 0x38, 0xe5,
    0x0d, 0x32, 0x11, 0x1e, 0x4c, 0xaf, 0x23, 0x7e, 0xe5, 0x3c,
    0xa8, 0xad, 0x64, 0x26, 0x19, 0x4a, 0x88, 0x54, 0x5d, 0xdc,
    0x49, 0x7a, 0x0b, 0x46, 0x6e, 0x7d, 0x6b, 0xbd, 0xb0, 0x04 };

unsigned char test5[] =
  { 0xf7, 0x98, 0xa1, 0x89, 0xf1, 0x95, 0xe6, 0x69, 0x82, 0x10,
    0x5f, 0xfb, 0x64, 0x0b, 0xb7, 0x75, 0x7f, 0x57, 0x9d, 0xa3,
    0x16, 0x02, 0xfc, 0x93, 0xec, 0x01, 0xac, 0x56, 0xf8, 0x5a,
    0xc3, 0xc1, 0x34, 0xa4, 0x54, 0x7b, 0x73, 0x3b, 0x46, 0x41,
    0x30, 0x42, 0xc9, 0x44, 0x00, 0x49, 0x17, 0x69, 0x05, 0xd3,
    0xbe, 0x59, 0xea, 0x1c, 0x53, 0xf1, 0x59, 0x16, 0x15, 0x5c,
    0x2b, 0xe8, 0x24, 0x1a, 0x38, 0x00, 0x8b, 0x9a, 0x26, 0xbc,
    0x35, 0x94, 0x1e, 0x24, 0x44, 0x17, 0x7c, 0x8a, 0xde, 0x66,
    0x89, 0xde, 0x95, 0x26, 0x49, 0x86, 0xd9, 0x58, 0x89, 0xfb,
    0x60, 0xe8, 0x46, 0x29, 0xc9, 0xbd, 0x9a, 0x5a, 0xcb, 0x1c,
    0xc1, 0x18, 0xbe, 0x56, 0x3e, 0xb9, 0xb3, 0xa4, 0xa4, 0x72,
    0xf8, 0x2e, 0x09, 0xa7, 0xe7, 0x78, 0x49, 0x2b, 0x56, 0x2e,
    0xf7, 0x13, 0x0e, 0x88, 0xdf, 0xe0, 0x31, 0xc7, 0x9d, 0xb9,
    0xd4, 0xf7, 0xc7, 0xa8, 0x99, 0x15, 0x1b, 0x9a, 0x47, 0x50,
    0x32, 0xb6, 0x3f, 0xc3, 0x85, 0x24, 0x5f, 0xe0, 0x54, 0xe3,
    0xdd, 0x5a, 0x97, 0xa5, 0xf5, 0x76, 0xfe, 0x06, 0x40, 0x25,
    0xd3, 0xce, 0x04, 0x2c, 0x56, 0x6a, 0xb2, 0xc5, 0x07, 0xb1,
    0x38, 0xdb, 0x85, 0x3e, 0x3d, 0x69, 0x59, 0x66, 0x09, 0x96,
    0x54, 0x6c, 0xc9, 0xc4, 0xa6, 0xea, 0xfd, 0xc7, 0x77, 0xc0,
    0x40, 0xd7, 0x0e, 0xaf, 0x46, 0xf7, 0x6d, 0xad, 0x39, 0x79,
    0xe5, 0xc5, 0x36, 0x0c, 0x33, 0x17, 0x16, 0x6a, 0x1c, 0x89,
    0x4c, 0x94, 0xa3, 0x71, 0x87, 0x6a, 0x94, 0xdf, 0x76, 0x28,
    0xfe, 0x4e, 0xaa, 0xf2, 0xcc, 0xb2, 0x7d, 0x5a, 0xaa, 0xe0,
    0xad, 0x7a, 0xd0, 0xf9, 0xd4, 0xb6, 0xad, 0x3b, 0x54, 0x09,
    0x87, 0x46, 0xd4, 0x52, 0x4d, 0x38, 0x40, 0x7a, 0x6d, 0xeb };

/* Note: why don't we use memset/memcmp? CompCert interpreter compatibility. */

static void
clear(unsigned char* o, unsigned int n)
{
  unsigned int i = 0;
  for (; i < n; i++) o[i] = 0;
}

static int
verify(unsigned char* x, unsigned char* y, unsigned int n)
{
  unsigned int i = 0, d = 0;
  for(; i < n; i++) d |= x[i] ^ y[i];
  return (1 & ((d - 1) >> 8)) - 1;
}

int
main()
{
  unsigned char i = 0;
  int r = 0;
  unsigned char buf[256];
  unsigned char key[32];
  unsigned char nonce[8];

  /* Test #1 */
  clear(buf, 256);
  clear(key,  32);
  clear(nonce, 8);

  r |= crypto_stream_chacha20(buf, 256, nonce, key);
  r |= verify(buf, test1, sizeof(test1));
  assert (r == 0 && "Test vector #1 failed");

  /* Test #2 */
  clear(buf, 256);
  clear(key,  32);
  clear(nonce, 8);

  key[31] = 0x01;

  r |= crypto_stream_chacha20(buf, 256, nonce, key);
  r |= verify(buf, test2, sizeof(test2));
  assert (r == 0 && "Test vector #2 failed");

  /* Test #3 */
  clear(buf, 256);
  clear(key,  32);
  clear(nonce, 8);

  nonce[7] = 0x01;

  r |= crypto_stream_chacha20(buf, 256, nonce, key);
  r |= verify(buf, test3, sizeof(test3));
  assert (r == 0 && "Test vector #3 failed");

  /* Test #4 */
  clear(buf, 256);
  clear(key,  32);
  clear(nonce, 8);

  nonce[0] = 0x01;

  r |= crypto_stream_chacha20(buf, 256, nonce, key);
  r |= verify(buf, test4, sizeof(test4));
  assert (r == 0 && "Test vector #4 failed");

  /* Test #5 */
  clear(buf, 256);
  clear(key,  32);
  clear(nonce, 8);

  for (i = 0; i < 32; i++) key[i]   = i;
  for (i = 0; i < 8;  i++) nonce[i] = i;

  r |= crypto_stream_chacha20(buf, 256, nonce, key);
  r |= verify(buf, test5, sizeof(test5));
  assert (r == 0 && "Test vector #5 failed");

  printf("OK\n");
  return r;
}
